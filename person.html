<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Персональная страница</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 30px;
            top: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .person-name {
            font-size: 2.5em;
            margin: 0;
            font-weight: 300;
        }

        .person-dates {
            font-size: 1.2em;
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .chat-container {
            height: 70vh;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
            font-size: 1.2em;
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #fff;
        }

        .chat-message {
            background: #f0f4ff;
            border-radius: 15px;
            padding: 15px 20px;
            position: relative;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            cursor: grab;
        }

        .chat-message:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .chat-message.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .message-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .message-date {
            color: #999;
            font-size: 0.9em;
        }

        .message-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .chat-message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .action-btn.delete {
            background: #f44336;
        }

        .action-btn.delete:hover {
            background: #d32f2f;
        }

        .message-content {
            line-height: 1.6;
            color: #333;
            word-wrap: break-word;
        }

        .message-image {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .photo-album {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .album-photo {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            aspect-ratio: 1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .album-photo:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .album-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .album-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        .album-title {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .album-count {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .photo-modal.show {
            display: flex;
        }

        .modal-content {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .modal-image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: none;
            max-height: none;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            cursor: grab;
            transition: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            transform-origin: center center;
        }

        .modal-image:active {
            cursor: grabbing;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .modal-nav:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .modal-prev {
            left: 20px;
        }

        .modal-next {
            right: 20px;
        }

        .modal-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1001;
        }

        .chat-input-area {
            background: white;
            padding: 20px;
            border-radius: 0 0 15px 15px;
            border-top: 1px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            transition: border-color 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-buttons {
            display: flex;
            gap: 10px;
        }

        .input-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .input-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .file-input {
            display: none;
        }

        .drag-placeholder {
            height: 4px;
            background: #667eea;
            border-radius: 2px;
            margin: 5px 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drag-placeholder.active {
            opacity: 1;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f44336;
        }

        .notification.warning {
            background: #ff9800;
        }

        .notification.info {
            background: #2196F3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .photo-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(244, 67, 54, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .photo-item:hover .photo-delete {
            opacity: 1;
        }

        .blog-post-delete {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            float: right;
            margin-top: -5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-button">← Назад к дереву</a>
            <h1 class="person-name" id="personName">Загрузка...</h1>
            <p class="person-dates" id="personDates"></p>
        </div>

        <div class="content">
            <div class="chat-container">
                <div class="chat-header">
                    💬 Личная страница - добавляйте сообщения, фотографии и воспоминания
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- Сообщения будут отображаться здесь -->
                </div>

                <div class="chat-input-area">
                    <div class="input-container">
                        <textarea id="messageInput" class="message-input"
                            placeholder="Напишите сообщение или воспоминание..." rows="1"></textarea>

                        <div class="input-buttons">
                            <button class="input-btn" id="photoBtn" title="Добавить фото">
                                📷
                            </button>
                            <button class="input-btn" id="sendBtn" title="Отправить">
                                ➤
                            </button>
                        </div>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для просмотра фотографий -->
    <div class="photo-modal" id="photoModal" onclick="closePhotoModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closePhotoModal()">×</button>
            <button class="modal-nav modal-prev" onclick="prevPhoto()">‹</button>
            <button class="modal-nav modal-next" onclick="nextPhoto()">›</button>
            <div class="modal-image-container">
                <img class="modal-image" id="modalImage" src="" alt="">
            </div>
            <div class="modal-info" id="modalInfo"></div>
        </div>
    </div>

    <script>
        let currentPersonId = null;
        let messages = [];
        let draggedElement = null;
        let dragPlaceholder = null;

        // Получение ID персоны из URL
        function getPersonIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Показ уведомлений
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');

            // Определяем класс в зависимости от типа
            let notificationClass = 'notification';
            if (type === 'error') {
                notificationClass += ' error';
            } else if (type === 'warning') {
                notificationClass += ' warning';
            } else if (type === 'info') {
                notificationClass += ' info';
            }

            notification.className = notificationClass;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 4000); // Увеличили время показа для предупреждений
        }

        // Загрузка информации о персоне
        async function loadPersonInfo() {
            currentPersonId = getPersonIdFromUrl();
            if (!currentPersonId) {
                showNotification('Не указан ID персоны', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/person/${currentPersonId}`);
                if (response.ok) {
                    const personData = await response.json();
                    document.getElementById('personName').textContent = personData.name || 'Неизвестно';
                    document.getElementById('personDates').textContent = personData.dates || '';
                    document.title = `${personData.name} - Персональная страница`;
                } else {
                    loadPersonInfoFromSource();
                }
            } catch (error) {
                loadPersonInfoFromSource();
            }
        }

        // Загрузка информации из source.txt (fallback)
        async function loadPersonInfoFromSource() {
            try {
                const response = await fetch('source.txt');
                if (response.ok) {
                    const text = await response.text();
                    const lines = text.split('\n');

                    let numericId = currentPersonId;
                    if (currentPersonId.startsWith('node')) {
                        numericId = currentPersonId.substring(4);
                    }

                    for (const line of lines) {
                        if (line.startsWith(numericId + ' -')) {
                            const personInfo = line.substring(line.indexOf('-') + 1).trim();
                            document.getElementById('personName').textContent = personInfo;
                            document.title = `${personInfo} - Персональная страница`;
                            break;
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки информации о персоне:', error);
                document.getElementById('personName').textContent = `Персона ${currentPersonId}`;
            }
        }

        // Загрузка сообщений
        async function loadMessages() {
            try {
                const response = await fetch(`/api/person/${currentPersonId}/messages`);
                if (response.ok) {
                    messages = await response.json();
                } else {
                    throw new Error('API недоступен');
                }
            } catch (error) {
                // Fallback - загрузка из localStorage
                messages = JSON.parse(localStorage.getItem(`messages_${currentPersonId}`) || '[]');
            }
            displayMessages();
        }

        // Отображение сообщений
        function displayMessages() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';

            messages.forEach((message, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                messageDiv.draggable = true;
                messageDiv.dataset.index = index;

                let messageContent;
                if (message.type === 'text') {
                    messageContent = `<div class="message-content">${message.content.replace(/\n/g, '<br>')}</div>`;
                } else if (message.type === 'image') {
                    // Поддержка как старых base64, так и новых URL
                    const imageUrl = typeof message.content === 'string' ? message.content : message.content.url;
                    const imageCaption = message.caption || 'Фото';
                    messageContent = `<img src="${imageUrl}" alt="${imageCaption}" class="message-image" onclick="openPhotoModal('${imageUrl}')">`;
                } else if (message.type === 'album') {
                    messageContent = createAlbumContent(message.content, index);
                }

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="message-date">${new Date(message.date).toLocaleString('ru-RU')}</div>
                        <div class="message-actions">
                            <button class="action-btn" onclick="moveMessageUp(${index})" title="Переместить вверх">↑</button>
                            <button class="action-btn" onclick="moveMessageDown(${index})" title="Переместить вниз">↓</button>
                            <button class="action-btn delete" onclick="deleteMessage(${index})" title="Удалить">×</button>
                        </div>
                    </div>
                    ${messageContent}
                `;

                // Добавляем обработчики drag & drop
                messageDiv.addEventListener('dragstart', handleDragStart);
                messageDiv.addEventListener('dragover', handleDragOver);
                messageDiv.addEventListener('drop', handleDrop);
                messageDiv.addEventListener('dragend', handleDragEnd);

                container.appendChild(messageDiv);
            });

            // Прокрутка к концу
            container.scrollTop = container.scrollHeight;
        }

        // Добавление текстового сообщения
        function addTextMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) {
                showNotification('Введите текст сообщения', 'error');
                return;
            }

            const message = {
                type: 'text',
                content: content,
                date: new Date().toISOString()
            };

            messages.push(message);
            input.value = '';
            saveMessages();
            displayMessages();
            showNotification('Сообщение добавлено');
        }

        // Функция загрузки фото на сервер
        async function uploadPhotoToServer(file) {
            // Проверяем размер файла (максимум 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                throw new Error(`Файл ${file.name} слишком большой (${(file.size / 1024 / 1024).toFixed(1)}MB). Максимальный размер: 10MB`);
            }

            console.log(`Загружаем файл: ${file.name}, размер: ${(file.size / 1024).toFixed(1)}KB`);

            const formData = new FormData();
            formData.append('photo', file);

            try {
                const response = await fetch(`/api/person/${currentPersonId}/photos`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Server returned error');
                }

                console.log('Фото успешно загружено:', result.photo);
                return result.photo;
            } catch (error) {
                console.error('Ошибка при загрузке фото:', error);
                throw new Error(`Ошибка загрузки ${file.name}: ${error.message}`);
            }
        }

        // Добавление фото (поддержка множественного выбора)
        async function addPhotoMessages(files) {
            // Преобразуем FileList в массив
            const fileArray = Array.from(files);
            console.log(`Начинаем загрузку ${fileArray.length} фото`);

            if (fileArray.length === 1) {
                // Одно фото - обычное сообщение
                showNotification('Загружаем фотографию...', 'info');
                try {
                    const uploadedPhoto = await uploadPhotoToServer(fileArray[0]);
                    const message = {
                        type: 'image',
                        content: uploadedPhoto.url,
                        filename: uploadedPhoto.filename,
                        caption: uploadedPhoto.caption,
                        date: new Date().toISOString()
                    };

                    messages.push(message);
                    saveMessages();
                    displayMessages();
                    showNotification('Фото добавлено');
                } catch (error) {
                    console.error('Ошибка загрузки фото:', error);
                    showNotification(error.message || 'Ошибка загрузки фото', 'error');
                }
            } else {
                // Несколько фото - создаем альбом
                showNotification(`Загружаем ${fileArray.length} фотографий...`, 'info');
                const uploadedPhotos = [];
                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                console.log('Создаем альбом из нескольких фото');

                // Загружаем все фото по одному с показом прогресса
                for (let i = 0; i < fileArray.length; i++) {
                    try {
                        console.log(`Загружаем фото ${i + 1}/${fileArray.length}: ${fileArray[i].name}`);
                        showNotification(`Загружаем фото ${i + 1} из ${fileArray.length}...`, 'info');

                        const uploadedPhoto = await uploadPhotoToServer(fileArray[i]);
                        uploadedPhotos.push({
                            url: uploadedPhoto.url,
                            filename: uploadedPhoto.filename,
                            caption: uploadedPhoto.caption
                        });
                        successCount++;
                        console.log(`Фото ${i + 1} загружено успешно`);
                    } catch (error) {
                        console.error(`Ошибка загрузки фото ${i + 1}:`, error);
                        errors.push(`${fileArray[i].name}: ${error.message}`);
                        errorCount++;
                    }
                }

                console.log(`Загрузка завершена. Успешно: ${successCount}, ошибок: ${errorCount}`);
                console.log('Uploaded photos:', uploadedPhotos);

                if (uploadedPhotos.length > 0) {
                    const albumMessage = {
                        type: 'album',
                        content: uploadedPhotos,
                        date: new Date().toISOString()
                    };

                    console.log('Создаем сообщение альбома:', albumMessage);
                    messages.push(albumMessage);
                    saveMessages();
                    displayMessages();

                    if (errorCount === 0) {
                        showNotification(`Альбом из ${uploadedPhotos.length} фото успешно создан`);
                    } else {
                        showNotification(`Альбом создан: ${successCount} фото загружено, ${errorCount} с ошибками`, 'warning');
                        // Показываем детали ошибок в консоли
                        console.warn('Детали ошибок:', errors);
                    }
                } else {
                    showNotification('Не удалось загрузить ни одного фото. Проверьте размер файлов и подключение к серверу', 'error');
                    if (errors.length > 0) {
                        console.error('Все ошибки:', errors);
                    }
                }
            }
        }

        // Создание содержимого альбома
        function createAlbumContent(photos, messageIndex) {
            const albumHtml = `
                <div class="photo-album">
                    <div class="album-header">
                        <div class="album-title">📸 Фотоальбом</div>
                        <div class="album-count">${photos.length} фото</div>
                    </div>
                    <div class="album-grid">
                        ${photos.map((photo, photoIndex) => {
                const photoUrl = typeof photo === 'string' ? photo : photo.url;
                const photoCaption = typeof photo === 'string' ? `Фото ${photoIndex + 1}` : (photo.caption || `Фото ${photoIndex + 1}`);
                return `
                                <div class="album-photo" onclick="openPhotoModal('${photoUrl}', ${messageIndex}, ${photoIndex})">
                                    <img src="${photoUrl}" alt="${photoCaption}">
                                </div>
                            `;
            }).join('')}
                    </div>
                </div>
            `;
            return albumHtml;
        }

        // Модальное окно для просмотра фотографий
        let currentModal = {
            messageIndex: -1,
            photoIndex: -1,
            photos: []
        };

        // Переменные для перетаскивания и масштабирования
        let imageState = {
            scale: 1,
            translateX: 0,
            translateY: 0,
            isDragging: false,
            lastX: 0,
            lastY: 0,
            initialScale: 1
        };

        function openPhotoModal(photoSrc, messageIndex = -1, photoIndex = 0) {
            const modal = document.getElementById('photoModal');
            const modalImage = document.getElementById('modalImage');
            const modalInfo = document.getElementById('modalInfo');

            // Сброс состояния изображения
            resetImageState();

            if (messageIndex >= 0 && messages[messageIndex] && messages[messageIndex].type === 'album') {
                // Альбом
                currentModal = {
                    messageIndex: messageIndex,
                    photoIndex: photoIndex,
                    photos: messages[messageIndex].content
                };
                const photo = currentModal.photos[photoIndex];
                const photoUrl = typeof photo === 'string' ? photo : photo.url;
                const photoCaption = typeof photo === 'string' ? `Фото ${photoIndex + 1}` : (photo.caption || `Фото ${photoIndex + 1}`);

                loadModalImage(photoUrl);
                modalInfo.textContent = `${photoCaption} (${photoIndex + 1} из ${currentModal.photos.length})`;

                // Показываем/скрываем кнопки навигации
                const prevBtn = document.querySelector('.modal-prev');
                const nextBtn = document.querySelector('.modal-next');
                if (currentModal.photos.length > 1) {
                    prevBtn.style.display = 'flex';
                    nextBtn.style.display = 'flex';
                } else {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                }
            } else {
                // Одиночное фото
                currentModal = {
                    messageIndex: -1,
                    photoIndex: 0,
                    photos: [photoSrc]
                };
                loadModalImage(photoSrc);
                modalInfo.textContent = 'Фото';

                // Скрываем кнопки навигации для одиночных фото
                document.querySelector('.modal-prev').style.display = 'none';
                document.querySelector('.modal-next').style.display = 'none';
            }

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            resetImageState();
        }

        // Функции для работы с изображением
        function resetImageState() {
            imageState = {
                scale: 1,
                translateX: 0,
                translateY: 0,
                isDragging: false,
                lastX: 0,
                lastY: 0,
                initialScale: 1
            };
        }

        function loadModalImage(src) {
            const modalImage = document.getElementById('modalImage');

            modalImage.onload = function () {
                calculateInitialScale();
                applyImageTransform();
                setupImageEventListeners();
            };

            modalImage.src = src;
        }

        function calculateInitialScale() {
            const modalImage = document.getElementById('modalImage');
            const container = document.querySelector('.modal-image-container');

            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            const imageWidth = modalImage.naturalWidth;
            const imageHeight = modalImage.naturalHeight;

            // Рассчитываем масштаб для помещения изображения в контейнер с отступами
            const scaleX = (containerWidth * 0.9) / imageWidth;
            const scaleY = (containerHeight * 0.9) / imageHeight;

            imageState.initialScale = Math.min(scaleX, scaleY, 1);
            imageState.scale = imageState.initialScale;
            imageState.translateX = 0;
            imageState.translateY = 0;
        }

        function applyImageTransform() {
            const modalImage = document.getElementById('modalImage');
            modalImage.style.transform = `translate(${imageState.translateX}px, ${imageState.translateY}px) scale(${imageState.scale})`;
        }

        function setupImageEventListeners() {
            const modalImage = document.getElementById('modalImage');
            const container = document.querySelector('.modal-image-container');

            // Удаляем старые обработчики
            modalImage.removeEventListener('mousedown', handleMouseDown);
            modalImage.removeEventListener('wheel', handleWheel);
            container.removeEventListener('wheel', handleWheel);

            // Добавляем новые обработчики
            modalImage.addEventListener('mousedown', handleMouseDown);
            modalImage.addEventListener('wheel', handleWheel);
            container.addEventListener('wheel', handleWheel);
        }

        function handleMouseDown(e) {
            e.preventDefault();
            imageState.isDragging = true;
            imageState.lastX = e.clientX;
            imageState.lastY = e.clientY;

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function handleMouseMove(e) {
            if (!imageState.isDragging) return;

            e.preventDefault();
            const deltaX = e.clientX - imageState.lastX;
            const deltaY = e.clientY - imageState.lastY;

            imageState.translateX += deltaX;
            imageState.translateY += deltaY;
            imageState.lastX = e.clientX;
            imageState.lastY = e.clientY;

            applyImageTransform();
        }

        function handleMouseUp(e) {
            imageState.isDragging = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }

        function handleWheel(e) {
            e.preventDefault();

            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = imageState.scale * delta;

            // Ограничиваем масштаб
            if (newScale < imageState.initialScale * 0.5) return;
            if (newScale > imageState.initialScale * 5) return;

            // Получаем позицию курсора относительно изображения
            const rect = document.getElementById('modalImage').getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const mouseX = e.clientX;
            const mouseY = e.clientY;

            // Рассчитываем новые координаты для масштабирования относительно курсора
            const factor = delta - 1;
            imageState.translateX -= (mouseX - centerX) * factor;
            imageState.translateY -= (mouseY - centerY) * factor;

            imageState.scale = newScale;
            applyImageTransform();
        }

        // Обработчик клавиатуры для модального окна
        function handleModalKeyboard(e) {
            if (!document.getElementById('photoModal').classList.contains('show')) return;

            switch (e.key) {
                case 'Escape':
                    closePhotoModal();
                    break;
                case 'ArrowLeft':
                    prevPhoto();
                    break;
                case 'ArrowRight':
                    nextPhoto();
                    break;
                case 'r':
                case 'R':
                    // Сброс масштаба и позиции
                    resetImageState();
                    calculateInitialScale();
                    applyImageTransform();
                    break;
                case '0':
                    // Масштаб 100%
                    imageState.scale = 1;
                    imageState.translateX = 0;
                    imageState.translateY = 0;
                    applyImageTransform();
                    break;
            }
        }

        function prevPhoto() {
            if (currentModal.photos.length <= 1) return;

            currentModal.photoIndex = (currentModal.photoIndex - 1 + currentModal.photos.length) % currentModal.photos.length;
            const photo = currentModal.photos[currentModal.photoIndex];
            const photoUrl = typeof photo === 'string' ? photo : photo.url;
            const photoCaption = typeof photo === 'string' ? `Фото ${currentModal.photoIndex + 1}` : (photo.caption || `Фото ${currentModal.photoIndex + 1}`);

            resetImageState();
            loadModalImage(photoUrl);
            document.getElementById('modalInfo').textContent = `${photoCaption} (${currentModal.photoIndex + 1} из ${currentModal.photos.length})`;
        }

        function nextPhoto() {
            if (currentModal.photos.length <= 1) return;

            currentModal.photoIndex = (currentModal.photoIndex + 1) % currentModal.photos.length;
            const photo = currentModal.photos[currentModal.photoIndex];
            const photoUrl = typeof photo === 'string' ? photo : photo.url;
            const photoCaption = typeof photo === 'string' ? `Фото ${currentModal.photoIndex + 1}` : (photo.caption || `Фото ${currentModal.photoIndex + 1}`);

            resetImageState();
            loadModalImage(photoUrl);
            document.getElementById('modalInfo').textContent = `${photoCaption} (${currentModal.photoIndex + 1} из ${currentModal.photos.length})`;
        }

        // Сохранение сообщений
        async function saveMessages() {
            try {
                const response = await fetch(`/api/person/${currentPersonId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(messages)
                });

                if (!response.ok) {
                    throw new Error('API недоступен');
                }
            } catch (error) {
                // Fallback - сохранение в localStorage
                localStorage.setItem(`messages_${currentPersonId}`, JSON.stringify(messages));
            }
        }

        // Удаление сообщения
        function deleteMessage(index) {
            if (!confirm('Удалить это сообщение?')) return;

            messages.splice(index, 1);
            saveMessages();
            displayMessages();
            showNotification('Сообщение удалено');
        }

        // Перемещение сообщения вверх
        function moveMessageUp(index) {
            if (index === 0) return;

            [messages[index], messages[index - 1]] = [messages[index - 1], messages[index]];
            saveMessages();
            displayMessages();
        }

        // Перемещение сообщения вниз
        function moveMessageDown(index) {
            if (index === messages.length - 1) return;

            [messages[index], messages[index + 1]] = [messages[index + 1], messages[index]];
            saveMessages();
            displayMessages();
        }

        // Обработчики Drag & Drop
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const afterElement = getDragAfterElement(e.clientY);
            const container = document.getElementById('chatMessages');

            if (!dragPlaceholder) {
                dragPlaceholder = document.createElement('div');
                dragPlaceholder.className = 'drag-placeholder active';
            }

            if (afterElement == null) {
                container.appendChild(dragPlaceholder);
            } else {
                container.insertBefore(dragPlaceholder, afterElement);
            }
        }

        function handleDrop(e) {
            e.preventDefault();

            if (draggedElement && dragPlaceholder) {
                const draggedIndex = parseInt(draggedElement.dataset.index);
                const allElements = [...document.querySelectorAll('.chat-message:not(.dragging)')];
                const placeholderIndex = Array.from(dragPlaceholder.parentNode.children).indexOf(dragPlaceholder);

                // Перемещаем элемент в массиве
                const [movedMessage] = messages.splice(draggedIndex, 1);
                let newIndex = placeholderIndex;

                if (draggedIndex < placeholderIndex) {
                    newIndex--;
                }

                messages.splice(newIndex, 0, movedMessage);
                saveMessages();
                displayMessages();
            }
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;

            if (dragPlaceholder) {
                dragPlaceholder.remove();
                dragPlaceholder = null;
            }
        }

        function getDragAfterElement(y) {
            const draggableElements = [...document.querySelectorAll('.chat-message:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Автоматическое изменение размера textarea
        function autoResize() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Инициализация обработчиков событий
        function initializeEventHandlers() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const photoBtn = document.getElementById('photoBtn');
            const fileInput = document.getElementById('fileInput');

            // Отправка сообщения
            sendBtn.addEventListener('click', addTextMessage);

            // Enter для отправки (Ctrl+Enter для новой строки)
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.ctrlKey) {
                    e.preventDefault();
                    addTextMessage();
                } else if (e.key === 'Enter' && e.ctrlKey) {
                    // Позволяем вставить новую строку
                }
            });

            // Автоизменение размера
            messageInput.addEventListener('input', autoResize);

            // Загрузка фото
            photoBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    const files = e.target.files;
                    console.log(`Выбрано файлов: ${files.length}`);

                    // Проверяем типы файлов
                    const validFiles = [];
                    for (let file of files) {
                        if (file.type.startsWith('image/')) {
                            validFiles.push(file);
                        } else {
                            console.warn(`Пропускаем файл ${file.name} - не является изображением`);
                        }
                    }

                    if (validFiles.length === 0) {
                        showNotification('Выберите файлы изображений', 'error');
                        e.target.value = '';
                        return;
                    }

                    if (validFiles.length !== files.length) {
                        showNotification(`Обрабатываем только ${validFiles.length} изображений из ${files.length} выбранных файлов`, 'warning');
                    }

                    await addPhotoMessages(validFiles);
                    e.target.value = '';
                }
            });
        }

        // Инициализация страницы
        window.addEventListener('load', () => {
            loadPersonInfo();
            loadMessages();
            initializeEventHandlers();

            // Добавляем обработчик клавиатуры для модального окна
            document.addEventListener('keydown', handleModalKeyboard);
        });
    </script>
</body>

</html>