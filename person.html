<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 30px;
            top: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .person-name {
            font-size: 2.5em;
            margin: 0;
            font-weight: 300;
        }

        .person-dates {
            font-size: 1.2em;
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .chat-container {
            height: 70vh;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            text-align: center;
            font-size: 1.2em;
            font-weight: 500;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #fff;
        }

        .chat-message {
            background: #f0f4ff;
            border-radius: 15px;
            padding: 15px 20px;
            position: relative;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
            cursor: grab;
        }

        .chat-message:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .chat-message.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .message-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .message-date {
            color: #999;
            font-size: 0.9em;
        }

        .message-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .chat-message:hover .message-actions {
            opacity: 1;
        }

        .action-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .action-btn.edit {
            background: #4caf50;
        }

        .action-btn.edit:hover {
            background: #45a049;
        }

        .action-btn.delete {
            background: #f44336;
        }

        .action-btn.delete:hover {
            background: #d32f2f;
        }

        .message-content {
            line-height: 1.6;
            color: #333;
            word-wrap: break-word;
        }

        .message-content.editing {
            display: none;
        }

        .message-edit-form {
            display: none;
        }

        .message-edit-form.active {
            display: block;
        }

        .message-edit-textarea {
            width: 100%;
            min-height: 80px;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 10px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            margin-bottom: 10px;
        }

        .message-edit-textarea:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        .edit-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .edit-btn {
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .edit-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .cancel-btn {
            background: #f44336;
        }

        .cancel-btn:hover {
            background: #d32f2f;
        }

        .message-image {
            max-width: 300px;
            max-height: 200px;
            width: auto;
            height: auto;
            border-radius: 10px;
            margin-top: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            object-fit: cover;
            position: relative;
            background: #f0f0f0;
        }

        .message-image:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .message-image:hover::after {
            content: "üîç";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            opacity: 0.9;
        }

        .photo-album {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-top: 10px;
            background: linear-gradient(145deg, #f8f9fa, #ffffff);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 6px;
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .album-grid::-webkit-scrollbar {
            width: 6px;
        }

        .album-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .album-grid::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .album-grid::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .album-photo:hover {
            transform: scale(1.03);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            will-change: transform;
        }

        .album-photo {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            aspect-ratio: 1;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
            background: #f0f0f0;
        }

        .album-photo:hover::after {
            content: "üîç";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0.9;
        }

        .album-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s ease;
        }

        .album-photo img[data-loading="true"] {
            opacity: 0.5;
        }

        .album-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 0 2px;
        }

        .album-title {
            font-weight: 600;
            color: #667eea;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .album-count {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .photo-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .photo-modal.show {
            display: flex;
        }

        .modal-content {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .modal-image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-image {
            max-width: none;
            max-height: none;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            cursor: grab;
            transition: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            transform-origin: center center;
        }

        .modal-image:active {
            cursor: grabbing;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .modal-nav:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .modal-prev {
            left: 20px;
        }

        .modal-next {
            right: 20px;
        }

        .modal-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1001;
        }

        .chat-input-area {
            background: white;
            padding: 20px;
            border-radius: 0 0 15px 15px;
            border-top: 1px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            min-height: 20px;
            max-height: 100px;
            transition: border-color 0.3s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-buttons {
            display: flex;
            gap: 10px;
        }

        .input-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .input-btn:hover {
            background: #764ba2;
            transform: scale(1.1);
        }

        .file-input {
            display: none;
        }

        .drag-placeholder {
            height: 4px;
            background: #667eea;
            border-radius: 2px;
            margin: 5px 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .drag-placeholder.active {
            opacity: 1;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #f44336;
        }

        .notification.warning {
            background: #ff9800;
        }

        .notification.info {
            background: #2196F3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .photo-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(244, 67, 54, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .photo-item:hover .photo-delete {
            opacity: 1;
        }

        .blog-post-delete {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            float: right;
            margin-top: -5px;
        }

        /* –õ–µ–Ω–∏–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .lazy-image[data-loading="true"] {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-button">‚Üê –ù–∞–∑–∞–¥ –∫ –¥–µ—Ä–µ–≤—É</a>
            <h1 class="person-name" id="personName">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            <p class="person-dates" id="personDates"></p>
        </div>

        <div class="content">
            <div class="chat-container">
                <div class="chat-header">
                    üí¨ –õ–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –¥–æ–±–∞–≤–ª—è–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
                </div>

                <div class="chat-messages" id="chatMessages">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>

                <div class="chat-input-area">
                    <div class="input-container">
                        <textarea id="messageInput" class="message-input"
                            placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ..." rows="1"></textarea>

                        <div class="input-buttons">
                            <button class="input-btn" id="photoBtn" title="–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ">
                                üì∑
                            </button>
                            <button class="input-btn" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
                                ‚û§
                            </button>
                        </div>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
    <div class="photo-modal" id="photoModal" onclick="closePhotoModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closePhotoModal()">√ó</button>
            <button class="modal-nav modal-prev" onclick="prevPhoto()">‚Äπ</button>
            <button class="modal-nav modal-next" onclick="nextPhoto()">‚Ä∫</button>
            <div class="modal-image-container">
                <img class="modal-image" id="modalImage" src="" alt="">
            </div>
            <div class="modal-info" id="modalInfo"></div>
        </div>
    </div>

    <script>
        let currentPersonId = null;
        let messages = [];
        let draggedElement = null;
        let dragPlaceholder = null;

        // –ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø–µ—Ä—Å–æ–Ω—ã –∏–∑ URL
        function getPersonIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–ª–∞—Å—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            let notificationClass = 'notification';
            if (type === 'error') {
                notificationClass += ' error';
            } else if (type === 'warning') {
                notificationClass += ' warning';
            } else if (type === 'info') {
                notificationClass += ' info';
            }

            notification.className = notificationClass;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 4000); // –£–≤–µ–ª–∏—á–∏–ª–∏ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä—Å–æ–Ω–µ
        async function loadPersonInfo() {
            currentPersonId = getPersonIdFromUrl();
            if (!currentPersonId) {
                showNotification('–ù–µ —É–∫–∞–∑–∞–Ω ID –ø–µ—Ä—Å–æ–Ω—ã', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/person/${currentPersonId}`);
                if (response.ok) {
                    const personData = await response.json();
                    document.getElementById('personName').textContent = personData.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    document.getElementById('personDates').textContent = personData.dates || '';
                    document.title = `${personData.name} - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞`;
                } else {
                    loadPersonInfoFromSource();
                }
            } catch (error) {
                loadPersonInfoFromSource();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–∑ source.txt (fallback)
        async function loadPersonInfoFromSource() {
            try {
                const response = await fetch('source.txt');
                if (response.ok) {
                    const text = await response.text();
                    const lines = text.split('\n');

                    let numericId = currentPersonId;
                    if (currentPersonId.startsWith('node')) {
                        numericId = currentPersonId.substring(4);
                    }

                    for (const line of lines) {
                        if (line.startsWith(numericId + ' -')) {
                            const personInfo = line.substring(line.indexOf('-') + 1).trim();
                            document.getElementById('personName').textContent = personInfo;
                            document.title = `${personInfo} - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞`;
                            break;
                        }
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–µ—Ä—Å–æ–Ω–µ:', error);
                document.getElementById('personName').textContent = `–ü–µ—Ä—Å–æ–Ω–∞ ${currentPersonId}`;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        async function loadMessages() {
            try {
                const response = await fetch(`/api/person/${currentPersonId}/messages`);
                if (response.ok) {
                    messages = await response.json();
                } else {
                    throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
            } catch (error) {
                // Fallback - –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
                messages = JSON.parse(localStorage.getItem(`messages_${currentPersonId}`) || '[]');
            }
            displayMessages();
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        function displayMessages() {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';

            messages.forEach((message, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                messageDiv.draggable = true;
                messageDiv.dataset.index = index;

                let messageContent;
                if (message.type === 'text') {
                    messageContent = `<div class="message-content" id="messageContent${index}">${message.content.replace(/\n/g, '<br>')}</div>`;
                } else if (message.type === 'image') {
                    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ —Å—Ç–∞—Ä—ã—Ö base64, —Ç–∞–∫ –∏ –Ω–æ–≤—ã—Ö URL
                    const imageUrl = typeof message.content === 'string' ? message.content : message.content.url;
                    const imageCaption = message.caption || '–§–æ—Ç–æ';
                    messageContent = `<img src="${imageUrl}" alt="${imageCaption}" class="message-image" onclick="openPhotoModal('${imageUrl}')">`;
                } else if (message.type === 'album') {
                    messageContent = createAlbumContent(message.content, index);
                }

                const messageDate = new Date(message.date).toLocaleString('ru-RU');
                const editedText = message.editedDate ? ` (–∏–∑–º. ${new Date(message.editedDate).toLocaleString('ru-RU')})` : '';

                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="message-date">${messageDate}${editedText}</div>
                        <div class="message-actions">
                            ${message.type === 'text' ? `<button class="action-btn edit" onclick="editMessage(${index})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úè</button>` : ''}
                            <button class="action-btn" onclick="moveMessageUp(${index})" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚Üë</button>
                            <button class="action-btn" onclick="moveMessageDown(${index})" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button>
                            <button class="action-btn delete" onclick="deleteMessage(${index})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                        </div>
                    </div>
                    ${messageContent}
                    ${message.type === 'text' ? `
                        <div class="message-edit-form" id="editForm${index}">
                            <textarea class="message-edit-textarea" id="editTextarea${index}">${message.content}</textarea>
                            <div class="edit-buttons">
                                <button class="edit-btn" onclick="saveEditedMessage(${index})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button class="edit-btn cancel-btn" onclick="cancelEdit(${index})">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </div>
                    ` : ''}
                `;

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag & drop
                messageDiv.addEventListener('dragstart', handleDragStart);
                messageDiv.addEventListener('dragover', handleDragOver);
                messageDiv.addEventListener('drop', handleDrop);
                messageDiv.addEventListener('dragend', handleDragEnd);

                container.appendChild(messageDiv);
            });

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –∫–æ–Ω—Ü—É
            container.scrollTop = container.scrollHeight;
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function addTextMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                return;
            }

            const message = {
                type: 'text',
                content: content,
                date: new Date().toISOString()
            };

            messages.push(message);
            input.value = '';
            saveMessages();
            displayMessages();
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function uploadPhotoToServer(file) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                throw new Error(`–§–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${(file.size / 1024 / 1024).toFixed(1)}MB). –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB`);
            }

            console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª: ${file.name}, —Ä–∞–∑–º–µ—Ä: ${(file.size / 1024).toFixed(1)}KB`);

            const formData = new FormData();
            formData.append('photo', file);

            try {
                const response = await fetch(`/api/person/${currentPersonId}/photos`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Server returned error');
                }

                console.log('–§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', result.photo);
                return result.photo;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–æ—Ç–æ:', error);
                throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${file.name}: ${error.message}`);
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞)
        async function addPhotoMessages(files) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º FileList –≤ –º–∞—Å—Å–∏–≤
            const fileArray = Array.from(files);
            console.log(`–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É ${fileArray.length} —Ñ–æ—Ç–æ`);

            if (fileArray.length === 1) {
                // –û–¥–Ω–æ —Ñ–æ—Ç–æ - –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                showNotification('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é...', 'info');
                try {
                    const uploadedPhoto = await uploadPhotoToServer(fileArray[0]);
                    const message = {
                        type: 'image',
                        content: uploadedPhoto.url,
                        filename: uploadedPhoto.filename,
                        caption: uploadedPhoto.caption,
                        date: new Date().toISOString()
                    };

                    messages.push(message);
                    saveMessages();
                    displayMessages();
                    showNotification('–§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', error);
                    showNotification(error.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ', 'error');
                }
            } else {
                // –ù–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ - —Å–æ–∑–¥–∞–µ–º –∞–ª—å–±–æ–º
                showNotification(`–ó–∞–≥—Ä—É–∂–∞–µ–º ${fileArray.length} —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π...`, 'info');
                const uploadedPhotos = [];
                let successCount = 0;
                let errorCount = 0;
                const errors = [];

                console.log('–°–æ–∑–¥–∞–µ–º –∞–ª—å–±–æ–º –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ');

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Ñ–æ—Ç–æ –ø–æ –æ–¥–Ω–æ–º—É —Å –ø–æ–∫–∞–∑–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                for (let i = 0; i < fileArray.length; i++) {
                    try {
                        console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ ${i + 1}/${fileArray.length}: ${fileArray[i].name}`);
                        showNotification(`–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ ${i + 1} –∏–∑ ${fileArray.length}...`, 'info');

                        const uploadedPhoto = await uploadPhotoToServer(fileArray[i]);
                        uploadedPhotos.push({
                            url: uploadedPhoto.url,
                            filename: uploadedPhoto.filename,
                            caption: uploadedPhoto.caption
                        });
                        successCount++;
                        console.log(`–§–æ—Ç–æ ${i + 1} –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ`);
                    } catch (error) {
                        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ ${i + 1}:`, error);
                        errors.push(`${fileArray[i].name}: ${error.message}`);
                        errorCount++;
                    }
                }

                console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£—Å–ø–µ—à–Ω–æ: ${successCount}, –æ—à–∏–±–æ–∫: ${errorCount}`);
                console.log('Uploaded photos:', uploadedPhotos);

                if (uploadedPhotos.length > 0) {
                    const albumMessage = {
                        type: 'album',
                        content: uploadedPhotos,
                        date: new Date().toISOString()
                    };

                    console.log('–°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–ª—å–±–æ–º–∞:', albumMessage);
                    messages.push(albumMessage);
                    saveMessages();
                    displayMessages();

                    if (errorCount === 0) {
                        showNotification(`–ê–ª—å–±–æ–º –∏–∑ ${uploadedPhotos.length} —Ñ–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω`);
                    } else {
                        showNotification(`–ê–ª—å–±–æ–º —Å–æ–∑–¥–∞–Ω: ${successCount} —Ñ–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, ${errorCount} —Å –æ—à–∏–±–∫–∞–º–∏`, 'warning');
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏
                        console.warn('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫:', errors);
                    }
                } else {
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–æ—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                    if (errors.length > 0) {
                        console.error('–í—Å–µ –æ—à–∏–±–∫–∏:', errors);
                    }
                }
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∞–ª—å–±–æ–º–∞ —Å –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π
        function createAlbumContent(photos, messageIndex) {
            const albumHtml = `
                <div class="photo-album">
                    <div class="album-header">
                        <div class="album-title">üì∏ –§–æ—Ç–æ–∞–ª—å–±–æ–º</div>
                        <div class="album-count">${photos.length} —Ñ–æ—Ç–æ</div>
                    </div>
                    <div class="album-grid" id="albumGrid${messageIndex}">
                        ${photos.map((photo, photoIndex) => {
                const photoUrl = typeof photo === 'string' ? photo : photo.url;
                const photoCaption = typeof photo === 'string' ? `–§–æ—Ç–æ ${photoIndex + 1}` : (photo.caption || `–§–æ—Ç–æ ${photoIndex + 1}`);
                return `
                                <div class="album-photo" onclick="openPhotoModal('${photoUrl}', ${messageIndex}, ${photoIndex})">
                                    <img data-src="${photoUrl}" alt="${photoCaption}" class="lazy-image" data-loading="true">
                                </div>
                            `;
            }).join('')}
                    </div>
                </div>
            `;

            // –ó–∞–ø—É—Å–∫–∞–µ–º –ª–µ–Ω–∏–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            setTimeout(() => initLazyLoading(messageIndex), 100);

            return albumHtml;
        }

        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
        let currentModal = {
            messageIndex: -1,
            photoIndex: -1,
            photos: []
        };

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
        let imageState = {
            scale: 1,
            translateX: 0,
            translateY: 0,
            isDragging: false,
            lastX: 0,
            lastY: 0,
            initialScale: 1
        };

        function openPhotoModal(photoSrc, messageIndex = -1, photoIndex = 0) {
            const modal = document.getElementById('photoModal');
            const modalImage = document.getElementById('modalImage');
            const modalInfo = document.getElementById('modalInfo');

            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            resetImageState();

            if (messageIndex >= 0 && messages[messageIndex] && messages[messageIndex].type === 'album') {
                // –ê–ª—å–±–æ–º
                currentModal = {
                    messageIndex: messageIndex,
                    photoIndex: photoIndex,
                    photos: messages[messageIndex].content
                };
                const photo = currentModal.photos[photoIndex];
                const photoUrl = typeof photo === 'string' ? photo : photo.url;
                const photoCaption = typeof photo === 'string' ? `–§–æ—Ç–æ ${photoIndex + 1}` : (photo.caption || `–§–æ—Ç–æ ${photoIndex + 1}`);

                loadModalImage(photoUrl);
                modalInfo.textContent = `${photoCaption} (${photoIndex + 1} –∏–∑ ${currentModal.photos.length})`;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                const prevBtn = document.querySelector('.modal-prev');
                const nextBtn = document.querySelector('.modal-next');
                if (currentModal.photos.length > 1) {
                    prevBtn.style.display = 'flex';
                    nextBtn.style.display = 'flex';
                } else {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                }
            } else {
                // –û–¥–∏–Ω–æ—á–Ω–æ–µ —Ñ–æ—Ç–æ
                currentModal = {
                    messageIndex: -1,
                    photoIndex: 0,
                    photos: [photoSrc]
                };
                loadModalImage(photoSrc);
                modalInfo.textContent = '–§–æ—Ç–æ';

                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Ñ–æ—Ç–æ
                document.querySelector('.modal-prev').style.display = 'none';
                document.querySelector('.modal-next').style.display = 'none';
            }

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            resetImageState();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        function resetImageState() {
            imageState = {
                scale: 1,
                translateX: 0,
                translateY: 0,
                isDragging: false,
                lastX: 0,
                lastY: 0,
                initialScale: 1
            };
        }

        function loadModalImage(src) {
            const modalImage = document.getElementById('modalImage');

            modalImage.onload = function () {
                calculateInitialScale();
                applyImageTransform();
                setupImageEventListeners();
            };

            modalImage.src = src;
        }

        function calculateInitialScale() {
            const modalImage = document.getElementById('modalImage');
            const container = document.querySelector('.modal-image-container');

            const containerWidth = container.clientWidth;
            const containerHeight = container.clientHeight;
            const imageWidth = modalImage.naturalWidth;
            const imageHeight = modalImage.naturalHeight;

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–± –¥–ª—è –ø–æ–º–µ—â–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
            const scaleX = (containerWidth * 0.9) / imageWidth;
            const scaleY = (containerHeight * 0.9) / imageHeight;

            imageState.initialScale = Math.min(scaleX, scaleY, 1);
            imageState.scale = imageState.initialScale;
            imageState.translateX = 0;
            imageState.translateY = 0;
        }

        function applyImageTransform() {
            const modalImage = document.getElementById('modalImage');
            modalImage.style.transform = `translate(${imageState.translateX}px, ${imageState.translateY}px) scale(${imageState.scale})`;
        }

        function setupImageEventListeners() {
            const modalImage = document.getElementById('modalImage');
            const container = document.querySelector('.modal-image-container');

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            modalImage.removeEventListener('mousedown', handleMouseDown);
            modalImage.removeEventListener('wheel', handleWheel);
            container.removeEventListener('wheel', handleWheel);

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
            modalImage.addEventListener('mousedown', handleMouseDown);
            modalImage.addEventListener('wheel', handleWheel);
            container.addEventListener('wheel', handleWheel);
        }

        function handleMouseDown(e) {
            e.preventDefault();
            imageState.isDragging = true;
            imageState.lastX = e.clientX;
            imageState.lastY = e.clientY;

            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function handleMouseMove(e) {
            if (!imageState.isDragging) return;

            e.preventDefault();
            const deltaX = e.clientX - imageState.lastX;
            const deltaY = e.clientY - imageState.lastY;

            imageState.translateX += deltaX;
            imageState.translateY += deltaY;
            imageState.lastX = e.clientX;
            imageState.lastY = e.clientY;

            applyImageTransform();
        }

        function handleMouseUp(e) {
            imageState.isDragging = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }

        function handleWheel(e) {
            e.preventDefault();

            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = imageState.scale * delta;

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±
            if (newScale < imageState.initialScale * 0.5) return;
            if (newScale > imageState.initialScale * 5) return;

            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const rect = document.getElementById('modalImage').getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const mouseX = e.clientX;
            const mouseY = e.clientY;

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫—É—Ä—Å–æ—Ä–∞
            const factor = delta - 1;
            imageState.translateX -= (mouseX - centerX) * factor;
            imageState.translateY -= (mouseY - centerY) * factor;

            imageState.scale = newScale;
            applyImageTransform();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function handleModalKeyboard(e) {
            if (!document.getElementById('photoModal').classList.contains('show')) return;

            switch (e.key) {
                case 'Escape':
                    closePhotoModal();
                    break;
                case 'ArrowLeft':
                    prevPhoto();
                    break;
                case 'ArrowRight':
                    nextPhoto();
                    break;
                case 'r':
                case 'R':
                    // –°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞ –∏ –ø–æ–∑–∏—Ü–∏–∏
                    resetImageState();
                    calculateInitialScale();
                    applyImageTransform();
                    break;
                case '0':
                    // –ú–∞—Å—à—Ç–∞–± 100%
                    imageState.scale = 1;
                    imageState.translateX = 0;
                    imageState.translateY = 0;
                    applyImageTransform();
                    break;
            }
        }

        function prevPhoto() {
            if (currentModal.photos.length <= 1) return;

            currentModal.photoIndex = (currentModal.photoIndex - 1 + currentModal.photos.length) % currentModal.photos.length;
            const photo = currentModal.photos[currentModal.photoIndex];
            const photoUrl = typeof photo === 'string' ? photo : photo.url;
            const photoCaption = typeof photo === 'string' ? `–§–æ—Ç–æ ${currentModal.photoIndex + 1}` : (photo.caption || `–§–æ—Ç–æ ${currentModal.photoIndex + 1}`);

            resetImageState();
            loadModalImage(photoUrl);
            document.getElementById('modalInfo').textContent = `${photoCaption} (${currentModal.photoIndex + 1} –∏–∑ ${currentModal.photos.length})`;
        }

        function nextPhoto() {
            if (currentModal.photos.length <= 1) return;

            currentModal.photoIndex = (currentModal.photoIndex + 1) % currentModal.photos.length;
            const photo = currentModal.photos[currentModal.photoIndex];
            const photoUrl = typeof photo === 'string' ? photo : photo.url;
            const photoCaption = typeof photo === 'string' ? `–§–æ—Ç–æ ${currentModal.photoIndex + 1}` : (photo.caption || `–§–æ—Ç–æ ${currentModal.photoIndex + 1}`);

            resetImageState();
            loadModalImage(photoUrl);
            document.getElementById('modalInfo').textContent = `${photoCaption} (${currentModal.photoIndex + 1} –∏–∑ ${currentModal.photos.length})`;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        async function saveMessages() {
            try {
                const response = await fetch(`/api/person/${currentPersonId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(messages)
                });

                if (!response.ok) {
                    throw new Error('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                }
            } catch (error) {
                // Fallback - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
                localStorage.setItem(`messages_${currentPersonId}`, JSON.stringify(messages));
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function deleteMessage(index) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;

            messages.splice(index, 1);
            saveMessages();
            displayMessages();
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function editMessage(index) {
            const messageContent = document.getElementById(`messageContent${index}`);
            const editForm = document.getElementById(`editForm${index}`);
            const textarea = document.getElementById(`editTextarea${index}`);

            // –°–∫—Ä—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            messageContent.style.display = 'none';
            editForm.classList.add('active');

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –≤ textarea
            textarea.value = messages[index].content;
            textarea.focus();

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä textarea
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        function saveEditedMessage(index) {
            const textarea = document.getElementById(`editTextarea${index}`);
            const newContent = textarea.value.trim();

            if (!newContent) {
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            messages[index].content = newContent;
            messages[index].editedDate = new Date().toISOString();

            saveMessages();
            displayMessages();
            showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ');
        }

        // –û—Ç–º–µ–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function cancelEdit(index) {
            const messageContent = document.getElementById(`messageContent${index}`);
            const editForm = document.getElementById(`editForm${index}`);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            messageContent.style.display = 'block';
            editForm.classList.remove('active');
        }

        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–≤–µ—Ä—Ö
        function moveMessageUp(index) {
            if (index === 0) return;

            [messages[index], messages[index - 1]] = [messages[index - 1], messages[index]];
            saveMessages();
            displayMessages();
        }

        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–Ω–∏–∑
        function moveMessageDown(index) {
            if (index === messages.length - 1) return;

            [messages[index], messages[index + 1]] = [messages[index + 1], messages[index]];
            saveMessages();
            displayMessages();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Drag & Drop
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const afterElement = getDragAfterElement(e.clientY);
            const container = document.getElementById('chatMessages');

            if (!dragPlaceholder) {
                dragPlaceholder = document.createElement('div');
                dragPlaceholder.className = 'drag-placeholder active';
            }

            if (afterElement == null) {
                container.appendChild(dragPlaceholder);
            } else {
                container.insertBefore(dragPlaceholder, afterElement);
            }
        }

        function handleDrop(e) {
            e.preventDefault();

            if (draggedElement && dragPlaceholder) {
                const draggedIndex = parseInt(draggedElement.dataset.index);
                const allElements = [...document.querySelectorAll('.chat-message:not(.dragging)')];
                const placeholderIndex = Array.from(dragPlaceholder.parentNode.children).indexOf(dragPlaceholder);

                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –º–∞—Å—Å–∏–≤–µ
                const [movedMessage] = messages.splice(draggedIndex, 1);
                let newIndex = placeholderIndex;

                if (draggedIndex < placeholderIndex) {
                    newIndex--;
                }

                messages.splice(newIndex, 0, movedMessage);
                saveMessages();
                displayMessages();
            }
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;

            if (dragPlaceholder) {
                dragPlaceholder.remove();
                dragPlaceholder = null;
            }
        }

        function getDragAfterElement(y) {
            const draggableElements = [...document.querySelectorAll('.chat-message:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ textarea
        function autoResize() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function initializeEventHandlers() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const photoBtn = document.getElementById('photoBtn');
            const fileInput = document.getElementById('fileInput');

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
            sendBtn.addEventListener('click', addTextMessage);

            // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (Ctrl+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.ctrlKey) {
                    e.preventDefault();
                    addTextMessage();
                } else if (e.key === 'Enter' && e.ctrlKey) {
                    // –ü–æ–∑–≤–æ–ª—è–µ–º –≤—Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
                }
            });

            // –ê–≤—Ç–æ–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞
            messageInput.addEventListener('input', autoResize);

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ
            photoBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', async (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    const files = e.target.files;
                    console.log(`–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${files.length}`);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤
                    const validFiles = [];
                    for (let file of files) {
                        if (file.type.startsWith('image/')) {
                            validFiles.push(file);
                        } else {
                            console.warn(`–ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–∞–π–ª ${file.name} - –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º`);
                        }
                    }

                    if (validFiles.length === 0) {
                        showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π', 'error');
                        e.target.value = '';
                        return;
                    }

                    if (validFiles.length !== files.length) {
                        showNotification(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ ${validFiles.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ ${files.length} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤`, 'warning');
                    }

                    await addPhotoMessages(validFiles);
                    e.target.value = '';
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏—à –¥–ª—è –≤—Å–µ—Ö textarea —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.addEventListener('keydown', (e) => {
                if (e.target.classList.contains('message-edit-textarea')) {
                    const textarea = e.target;
                    const index = textarea.id.replace('editTextarea', '');

                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        saveEditedMessage(parseInt(index));
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelEdit(parseInt(index));
                    }
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            addImageLoadingStates();
            loadPersonInfo();
            loadMessages();
            initializeEventHandlers();

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.addEventListener('keydown', handleModalKeyboard);
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∞–ª—å–±–æ–º–∞
        function initLazyLoading(messageIndex) {
            const albumGrid = document.getElementById(`albumGrid${messageIndex}`);
            if (!albumGrid) return;

            const lazyImages = albumGrid.querySelectorAll('.lazy-image');
            if (!lazyImages.length) return;

            // –°–æ–∑–¥–∞–µ–º Intersection Observer –¥–ª—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const src = img.getAttribute('data-src');

                        if (src) {
                            img.src = src;
                            img.onload = () => {
                                img.removeAttribute('data-loading');
                                img.classList.remove('lazy-image');
                            };
                            img.onerror = () => {
                                img.removeAttribute('data-loading');
                                img.alt = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                            };
                            img.removeAttribute('data-src');
                        }

                        observer.unobserve(img);
                    }
                });
            }, {
                root: albumGrid,
                rootMargin: '50px',
                threshold: 0.1
            });

            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–µ 6 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å—Ä–∞–∑—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const immediateImages = Array.from(lazyImages).slice(0, 6);
            const delayedImages = Array.from(lazyImages).slice(6);

            immediateImages.forEach(img => {
                const src = img.getAttribute('data-src');
                if (src) {
                    img.src = src;
                    img.onload = () => {
                        img.removeAttribute('data-loading');
                        img.classList.remove('lazy-image');
                    };
                    img.onerror = () => {
                        img.removeAttribute('data-loading');
                        img.alt = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                    };
                    img.removeAttribute('data-src');
                }
            });

            // –û—Å—Ç–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
            delayedImages.forEach(img => {
                imageObserver.observe(img);
            });
        }

        // –î–æ–±–∞–≤–ª—è–µ–º loading placeholder –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        function addImageLoadingStates() {
            const style = document.createElement('style');
            style.textContent = `
                .lazy-image[data-loading="true"] {
                    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
                    background-size: 200% 100%;
                    animation: loading 1.5s infinite;
                }
                
                @keyframes loading {
                    0% { background-position: 200% 0; }
                    100% { background-position: -200% 0; }
                }
            `;
            document.head.appendChild(style);
        }

        addImageLoadingStates();
    </script>
</body>

</html>